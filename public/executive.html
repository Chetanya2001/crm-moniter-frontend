<!DOCTYPE html>
<html>
  <head>
    <title>Executive</title>
  </head>
  <body>
    <h2>Executive: Sharing Screen + Camera + Mic</h2>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
      const socket = io(
        "https://crm-monitor-backend-production.up.railway.app",
        { query: { userId: "exec1", role: "executive" } }
      );
      let peer;

      async function start() {
        try {
          const screen = await navigator.mediaDevices.getDisplayMedia({
            video: { frameRate: 5 },
          });

          const camMic = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480, frameRate: 15 },
            audio: true,
          });

          const combinedStream = new MediaStream([
            ...screen.getVideoTracks(),
            ...camMic.getVideoTracks(),
            ...camMic.getAudioTracks(),
          ]);

          peer = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
          });

          combinedStream
            .getTracks()
            .forEach((track) => peer.addTrack(track, combinedStream));

          peer.onicecandidate = (event) => {
            if (event.candidate) {
              socket.emit("ice-candidate", {
                targetId: "admin",
                candidate: event.candidate,
              });
            }
          };

          const offer = await peer.createOffer();
          await peer.setLocalDescription(offer);
          socket.emit("offer", { targetId: "admin", offer });

          socket.on("answer", async ({ answer }) => {
            await peer.setRemoteDescription(new RTCSessionDescription(answer));
          });

          socket.on("ice-candidate", ({ candidate }) => {
            peer.addIceCandidate(new RTCIceCandidate(candidate));
          });
        } catch (err) {
          console.error("Streaming error:", err);
        }
      }

      start();
    </script>
  </body>
</html>
