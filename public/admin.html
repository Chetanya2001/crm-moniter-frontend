<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin: View Executive Streams</title>
    <style>
      #video-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 20px;
        padding: 20px;
      }
      video {
        width: 100%;
        border: 2px solid #ccc;
        background: black;
      }
    </style>
  </head>
  <body>
    <h2>Admin: View Stream</h2>
    <div id="video-container"></div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
      const socket = io(
        "https://crm-monitor-backend-production.up.railway.app",
        {
          query: { userId: "admin", role: "admin" },
        }
      );

      const peers = {};
      const mediaMap = {}; // senderId â†’ MediaStream

      socket.on("offer", async ({ offer, senderId }) => {
        console.log("Received offer from:", senderId);

        const peer = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });

        peers[senderId] = peer;

        peer.ontrack = (event) => {
          console.log(
            "ontrack fired for:",
            senderId,
            "Track kind:",
            event.track.kind
          );

          const track = event.track;
          const idSafe = senderId.replace(/[^a-zA-Z0-9]/g, "");

          if (!mediaMap[idSafe]) {
            mediaMap[idSafe] = new MediaStream();
          }

          mediaMap[idSafe].addTrack(track);

          if (document.getElementById(`stream-${idSafe}`)) return;

          const video = document.createElement("video");
          video.id = `stream-${idSafe}`;
          video.srcObject = mediaMap[idSafe];
          video.autoplay = true;
          video.controls = true;
          video.playsInline = true;
          video.muted = true; // allow autoplay without interaction

          video.onloadedmetadata = () => {
            video.play().catch((err) => console.error("Playback error:", err));
          };

          const label = document.createElement("p");
          label.textContent = `EXECUTIVE (${senderId.slice(0, 5)}...)`;

          const container = document.createElement("div");
          container.appendChild(label);
          container.appendChild(video);
          document.getElementById("video-container").appendChild(container);
        };

        peer.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit("ice-candidate", {
              targetId: senderId,
              candidate: event.candidate,
            });
          }
        };

        await peer.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peer.createAnswer();
        await peer.setLocalDescription(answer);
        socket.emit("answer", {
          targetId: senderId,
          answer: peer.localDescription,
        });
      });

      socket.on("ice-candidate", ({ senderId, candidate }) => {
        const peer = peers[senderId];
        if (peer && candidate) {
          peer.addIceCandidate(new RTCIceCandidate(candidate));
          console.log("ICE candidate added for:", senderId);
        }
      });
    </script>
  </body>
</html>
